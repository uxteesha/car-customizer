<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Car AR: Quick Test</title>

  <!-- model-viewer (stable release) -->
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>

  <style>
    html,body { height:100%; margin:0; background:#111; }
    .wrap { width:100%; height:100%; position:relative; display:flex; align-items:center; justify-content:center; }

    model-viewer {
      width:100%;
      height:100%;
      display:block;
      background: #222;
    }

    /* big AR button overlay */
    .ar-ui {
      position: absolute;
      bottom: 32px;
      left: 50%;
      transform: translateX(-50%);
      display:flex;
      gap:10px;
      z-index: 40;
      pointer-events: none; /* allow clicks through unless the button itself */
    }

    .btn {
      pointer-events: auto;
      padding: 12px 18px;
      background:#007bff;
      color:#fff;
      border-radius:10px;
      border: none;
      font-weight:700;
      box-shadow: 0 8px 20px rgba(0,0,0,0.35);
      cursor:pointer;
    }

    .status {
      position: absolute;
      top: 12px;
      left: 12px;
      z-index: 50;
      color:#fff;
      background: rgba(0,0,0,0.45);
      padding:8px 10px;
      border-radius:8px;
      font-size:13px;
    }

    .note {
      position: absolute;
      top: 12px;
      right: 12px;
      z-index: 50;
      color:#fff;
      background: rgba(0,0,0,0.45);
      padding:8px 10px;
      border-radius:8px;
      font-size:13px;
      max-width:40%;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Replace the src with the exact URL / filename of your .glb -->
    <!-- If your filename has spaces, use encodeURI() or replace spaces with %20 in the src. -->
    <model-viewer id="mv"
      src="grey sedan.glb"
      alt="Car model"
      camera-controls
      auto-rotate
      exposure="1"
      shadow-intensity="1"
      ar
      ar-modes="webxr scene-viewer quick-look"
      ar-placement="floor"
      ar-scale="fixed"
      style="background: transparent;">
    </model-viewer>

    <div class="status" id="status">Initializing…</div>
    <div class="note" id="note">Tip: test on Android Chrome (ARCore) for best results. If nothing happens, check DevTools → Network (404 for GLB) or test device AR support.</div>

    <div class="ar-ui">
      <button id="enterAr" class="btn">Enter AR</button>
      <button id="placeDefault" class="btn">Place on Floor</button>
    </div>
  </div>

<script>
  const mv = document.getElementById('mv');
  const status = document.getElementById('status');
  const enterBtn = document.getElementById('enterAr');
  const placeBtn = document.getElementById('placeDefault');

  // Helper: encode spacey filenames for safety when swapping
  function encodePath(p){ try { return encodeURI(p); } catch(e){ return p; } }

  // 1) When model is loaded into the viewer (3D view)
  mv.addEventListener('load', () => {
    console.log('model-viewer: model load event');
    status.textContent = 'Model ready (3D view). Tap Enter AR to place in room.';
  });

  mv.addEventListener('error', (ev) => {
    console.error('model-viewer error', ev);
    status.textContent = 'Model failed to load — check console/network.';
  });

  // 2) Check whether AR is available via the model-viewer feature
  // model-viewer exposes .canActivateAR() async method on element
  async function updateArSupport() {
    // model-viewer v1 exposes canActivateAR as method returning a promise
    let supported = false;
    try {
      // some builds support canActivateAR, others expose a fewer methods — guard it
      if (typeof mv.canActivateAR === 'function') {
        supported = await mv.canActivateAR();
      } else if (navigator.xr && navigator.xr.isSessionSupported) {
        // fallback check for WebXR immersive-ar
        supported = await navigator.xr.isSessionSupported('immersive-ar');
      } else {
        supported = false;
      }
    } catch (e) {
      supported = false;
    }

    if (supported) {
      status.textContent = 'AR available on this device. Tap Enter AR.';
      enterBtn.disabled = false;
      placeBtn.disabled = false;
    } else {
      status.textContent = 'AR not available (or needs Scene Viewer / Quick Look). Enter AR will attempt fallback.';
      enterBtn.disabled = false; // let user try fallback (scene-viewer / quick-look)
      placeBtn.disabled = true;
    }
  }

  updateArSupport();

  // 3) Manual Enter AR (tries WebXR first; then falls back)
  enterBtn.addEventListener('click', async () => {
    status.textContent = 'Trying to enter AR…';
    try {
      // activateAR is provided by model-viewer and will trigger the AR flow
      await mv.activateAR();
      // if returns without error, browser entered AR or handed off to Scene Viewer / Quick Look
      // model-viewer also fires 'ar-status' events in some builds; but we can detect via visibility
      status.textContent = 'AR s
